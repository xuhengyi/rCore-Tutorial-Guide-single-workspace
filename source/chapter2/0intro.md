# 引言

## 本章导读

**批处理系统** (Batch System) 出现于计算资源匮乏的年代，其核心思想是：将多个程序打包到一起输入计算机；当一个程序运行结束后，计算机会 *自动* 执行下一个程序。

应用程序难免会出错，如果一个程序的错误导致整个操作系统都无法运行，那就太糟糕了。*保护* 操作系统不受出错程序破坏的机制被称为 **特权级** (Privilege) 机制，它实现了用户态和内核态的隔离。

本章在上一章的基础上，让我们的 OS 内核能以批处理的形式一次运行多个应用程序，同时利用特权级机制，令 OS 不因出错的用户态程序而崩溃。

本章首先为批处理操作系统设计用户程序，再阐述如何将这些应用程序链接到内核中，最后介绍如何利用特权级机制处理 Trap。

## 实践体验

本章我们引入了用户程序。在本项目的代码框架中，用户程序已经作为数据段链接到内核中。

在 qemu 模拟器上运行本章代码：

```bash
$ cd ch2
$ cargo run
```

批处理系统会自动加载并运行所有的用户程序，尽管某些程序可能会出错。

## 本章代码树

```
rCore-Tutorial-in-single-workspace/
├── ch2/
│   ├── Cargo.toml          # 项目配置文件
│   ├── build.rs            # 构建脚本
│   ├── README.md           # 本章说明文档
│   └── src/
│       └── main.rs         # 内核主函数，包含批处理逻辑
├── linker/                 # 链接脚本和应用程序管理库
│   └── src/
│       ├── lib.rs          # 链接脚本定义和内核布局
│       └── app.rs          # 应用程序元数据管理
├── kernel-context/         # 内核上下文管理库
│   └── src/
│       └── lib.rs          # LocalContext 实现
├── syscall/                # 系统调用库
│   └── src/
│       └── lib.rs          # 系统调用处理
├── console/                # 控制台库
│   └── src/
│       └── lib.rs          # 控制台输出实现
└── user/                   # 用户程序（如果存在）
    └── src/
        └── bin/            # 各个应用程序
```

本章代码相比第一章更加复杂，主要新增了：

- **批处理系统**：能够依次加载和运行多个应用程序
- **特权级切换**：通过 `LocalContext` 实现用户态和内核态的切换
- **系统调用处理**：处理用户程序的系统调用请求
- **Trap 处理**：通过 `LocalContext::execute()` 实现 Trap 的捕获和处理
