# 第八章：并发

## 目录

1. [引言](0intro.md)
2. [内核态的线程管理](1thread-kernel.md)
3. [锁机制](2lock.md)
4. [信号量机制](3semaphore.md)
5. [条件变量机制](4condition-variable.md)
6. [练习](5exercise.md)

## 本章目标

本章的目标是实现线程管理和同步互斥机制，支持进程内的多线程并发执行，并提供互斥锁、信号量、条件变量等同步原语。

## 主要内容

1. **线程管理**：引入线程概念，进程成为线程的资源容器
2. **互斥锁**：实现基于等待队列的睡眠锁，保证临界区互斥访问
3. **信号量**：实现更灵活的同步互斥机制，支持多个线程同时访问资源
4. **条件变量**：实现线程间条件等待和唤醒机制

## 代码位置

本章的代码位于 `rCore-Tutorial-in-single-workspace/ch8/` 目录下。

主要文件：
- `src/main.rs` - 内核主函数（含线程、同步初始化）
- `src/process.rs` - 进程管理（含线程）
- `src/processor.rs` - 处理器管理（含线程调度）
- `src/fs.rs` - 文件系统封装
- `src/virtio_block.rs` - VirtIO 块设备驱动

主要依赖库：
- `sync` - 同步互斥机制库（mutex、semaphore、condvar）
- `rcore-task-manage` - 任务管理库（支持线程）
- `signal` / `signal-impl` - 信号模块
- `easy-fs` - 文件系统
- `kernel-vm` - 虚拟内存管理库
- `kernel-context` - 内核上下文管理库

## 运行方法

```bash
$ cd ch8
$ cargo run
```

运行后会进入 Shell 界面，可以测试线程创建、同步互斥等功能。

## 关键概念

- **线程**：进程内的执行实体，共享进程的地址空间和文件，但有自己的栈和上下文
- **互斥锁**：保证临界区互斥访问的机制
- **信号量**：更灵活的同步互斥机制，支持多个线程同时访问资源
- **条件变量**：用于线程间条件等待和唤醒的机制
- **临界区**：访问共享资源的代码片段
- **竞态条件**：多线程并发访问共享数据导致的不确定结果

## 与第七章的对比

| 特性 | 第七章 | 第八章 |
|------|--------|--------|
| 执行实体 | 进程 | 线程（进程成为资源容器） |
| 并发粒度 | 进程级 | 线程级（更细粒度） |
| 同步机制 | 无 | 互斥锁、信号量、条件变量 |
| 资源共享 | 进程间隔离 | 线程间共享进程资源 |

## 注意事项

- 实验指导书存在的目的是帮助读者理解框架代码
- 为便于测试，完成编程实验时，请以框架代码为基础，不必跟着文档从零开始编写内核
- 本章实现了基本的线程管理和同步互斥机制，但某些功能（如死锁检测）可能还有待完善
- 线程退出和资源回收需要特别注意，主线程退出会导致整个进程退出
